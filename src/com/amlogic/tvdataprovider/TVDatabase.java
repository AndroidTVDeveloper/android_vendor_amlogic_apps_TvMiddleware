package com.amlogic.tvdataprovider;

import java.io.File;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteOpenHelper;
import android.content.Context;
import android.content.ContentValues;
import android.content.SharedPreferences;
import android.preference.PreferenceManager;
import android.util.Log;
import com.amlogic.tvutil.TVChannelParams;
import com.amlogic.tvutil.TVDimension;

public class TVDatabase extends SQLiteOpenHelper
{
	private static final String TAG = "TVDatabase";
	private static final int DB_VERSION = 4;
	private static final String DB_VERSION_FIELD = "DATABASE_VERSION";

	/*implemented by libjnidvbdatabase.so*/
	private native void native_db_setup(String name, boolean create, SQLiteDatabase db);
	private native void native_db_unsetup();
	private native static void native_db_sync();

	/*Regions*/
	private static class TVRegion {
		private String name;
		private int source;
		private String freqList;

		public TVRegion(String rn, int src, String fl) {
			name = rn;
			source = src;
			freqList = fl;
		}
	};

	private static final TVRegion tvRegions[] = {
		/* default DVB-C */
		new TVRegion("Default DVB-C", TVChannelParams.MODE_QAM, 
					"52500000 60250000 68500000 80000000 88000000 115000000 123000000 131000000 139000000 147000000 155000000 163000000 "+
					"171000000 179000000 187000000 195000000 203000000 211000000 219000000 227000000 235000000 243000000 251000000 259000000 "+
					"267000000 275000000 283000000 291000000 299000000 307000000 315000000 323000000 331000000 339000000 347000000 355000000 "+
					"363000000 371000000 379000000 387000000 395000000 403000000 411000000 419000000 427000000 435000000 443000000 451000000 "+
					"459000000 467000000 474000000 482000000 490000000 498000000 506000000 514000000 522000000 530000000 538000000 546000000 "+
					"554000000 562000000 570000000 578000000 586000000 594000000 602000000 610000000 618000000 626000000 634000000 642000000 "+
					"650000000 658000000 666000000 674000000 682000000 690000000 698000000 706000000 714000000 722000000 730000000 738000000 "+
					"746000000 754000000 762000000 770000000 778000000 786000000 794000000 802000000 810000000 818000000 826000000 834000000 "+
					"842000000 850000000 858000000 866000000 874000000"),
		new TVRegion("ATSC Air U.S.", TVChannelParams.MODE_ATSC,
					"57000000 63000000 69000000 79000000 85000000 177000000 183000000 189000000 195000000 201000000 207000000 213000000 "+
					"473000000 479000000 485000000 491000000 497000000 503000000 509000000 515000000 521000000 527000000 533000000 539000000 "+	
					"545000000 551000000 557000000 563000000 569000000 575000000 581000000 587000000 593000000 599000000 605000000 611000000 "+
					"617000000 623000000 629000000 635000000 641000000 647000000 653000000 659000000 665000000 671000000 677000000 683000000 "+
					"689000000 695000000 701000000 707000000 713000000 719000000 725000000 731000000 737000000 743000000 749000000 755000000 "+
					"761000000 767000000 773000000 779000000 785000000 791000000 797000000 803000000 809000000 815000000 821000000 827000000 "+	
					"833000000 839000000 845000000 851000000 857000000 863000000 869000000 875000000 881000000 887000000"),
		new TVRegion("ATSC Cable Standard U.S.", TVChannelParams.MODE_ATSC,
					"57000000 63000000 69000000 79000000 85000000 177000000 183000000 189000000 195000000 201000000 207000000 213000000 "     +
					"123012500 129012500 135012500 141000000 147000000 153000000 159000000 165000000 171000000 219000000 225000000 231012500 "+
					"237012500 243012500 249012500 255012500 261012500 267012500 273012500 279012500 285012500 291012500 297012500 303012500 "+
					"309012500 315012500 321012500 327012500 333025000 339012500 345012500 351012500 357012500 363012500 369012500 375012500 "+
					"381012500 387012500 393012500 399012500 405000000 411000000 417000000 423000000 429000000 435000000 441000000 447000000 "+
					"453000000 459000000 465000000 471000000 477000000 483000000 489000000 495000000 501000000 507000000 513000000 519000000 "+
					"525000000 531000000 537000000 543000000 549000000 555000000 561000000 567000000 573000000 579000000 585000000 591000000 "+
					"597000000 603000000 609000000 615000000 621000000 627000000 633000000 639000000 645000000 93000000 99000000 105000000 "  +
					"111025000 117025000 651000000 657000000 663000000 669000000 675000000 681000000 687000000 693000000 699000000 705000000 "+
					"711000000 717000000 723000000 729000000 735000000 741000000 747000000 753000000 759000000 765000000 771000000 777000000 "+
					"783000000 789000000 795000000 801000000 807000000 813000000 819000000 825000000 831000000 837000000 843000000 849000000 "+
					"855000000 861000000"),
		new TVRegion("ATSC Cable IRC U.S.", TVChannelParams.MODE_ATSC,
					"75012500 57012500 63012500 69012500 81012500 87012500 177012500 183012500 189012500 195012500 201012500 207012500 "       +
					"213012500 123012500 129012500 135012500 141012500 147012500 153012500 159012500 165012500 171012500 219012500 225012500 " +
					"231012500 237012500 243012500 249012500 255012500 261012500 267012500 273012500 279012500 285012500 291012500 297012500 " +
					"303012500 309012500 315012500 321012500 327012500 333025000 339012500 345012500 351012500 357012500 363012500 369012500 " +
					"375012500 381012500 387012500 393012500 399012500 405012500 411012500 417012500 423012500 429012500 435012500 441012500 " +
					"447012500 453012500 459012500 465012500 471012500 477012500 483012500 489012500 495012500 501012500 507012500 513012500 " +
					"519012500 525012500 531012500 537012500 543012500 549012500 555012500 561012500 567012500 573012500 579012500 585012500 " +
					"591012500 597012500 603012500 609012500 615012500 621012500 627012500 633012500 639012500 645012500 93012500 99012500 "   +
					"105012500 111025000 117025000 651012500 657012500 663012500 669012500 675012500 681012500 687012500 693012500 699012500 " +
					"705012500 711012500 717012500 723012500 729012500 735012500 741012500 747012500 753012500 759012500 765012500 771012500 " +
					"777012500 783012500 789012500 795012500 801012500 807012500 813012500 819012500 825012500 831012500 837012500 843012500 " +
					"849012500 855012500 861012500"),
		new TVRegion("ATSC Cable HRC U.S.", TVChannelParams.MODE_ATSC,
					"73753600 55752700 61753000 67753300 79753900 85754200 175758700 181759000 187759300 193759600 199759900 205760200 "       + 
					"211760500 121756000 127756300 133756600 139756900 145757200 151757500 157757800 163758100 169758400 217760800 223761100 " +
					"229761400 235761700 241762000 247762300 253762600 259762900 265763200 271763500 277763800 283764100 289764400 295764700 " +
					"301765000 307765300 313765600 319765900 325766200 331766500 337766800 343767100 349767400 355767700 361768000 367768300 " +
					"373768600 379768900 385769200 391769500 397769800 403770100 409770400 415770700 421771000 427771300 433771600 439771900 " +
					"445772200 451772500 457772800 463773100 469773400 475773700 481774000 487774300 493774600 499774900 505775200 511775500 " +
					"517775800 523776100 529776400 535776700 541777000 547777300 553777600 559777900 565778200 571778500 577778800 583779100 " +
					"589779400 595779700 601780000 607780300 613780600 619780900 625781200 631781500 637781800 643782100 91754500 97754800   " +
					"103755100 109755400 115755700 649782400 655782700 661783000 667783300 673783600 679783900 685784200 691784500 697784800 " +
					"703785100 709785400 715785700 721786000 727786300 733786600 739786900 745787200 751787500 757787800 763788100 769788400 " +
					"775788700 781789000 787789300 793789600 799789900 805790200 811790500 817790800 823791100 829791400 835791700 841792000 " +
					"847792300 853792600 859792900"),
		new TVRegion("Default DVB-T UK", TVChannelParams.MODE_OFDM,
					"474000000 0 482000000 0 490000000 0 498000000 0 506000000 0 514000000 0 522000000 0 530000000 0 " +
					"538000000 0 546000000 0 554000000 0 562000000 0 570000000 0 578000000 0 586000000 0 594000000 0 " +
					"602000000 0 610000000 0 618000000 0 626000000 0 634000000 0 642000000 0 650000000 0 658000000 0 " +
					"666000000 0 674000000 0 682000000 0 690000000 0 698000000 0 706000000 0 714000000 0 722000000 0 " +
					"730000000 0 738000000 0 746000000 0 754000000 0 762000000 0 770000000 0 778000000 0 786000000 0 " +
					"794000000 0 802000000 0 810000000 0 818000000 0 826000000 0 834000000 0 842000000 0 850000000 0 " +					
					"858000000 0 "),
		new TVRegion("Default DVB-T AUSTRALIA", TVChannelParams.MODE_OFDM,
					"177500000 1 184500000 1 191500000 1 198500000 1 205500000 1 212500000 1 219500000 1 226500000 1 " +
					"522500000 1 529500000 1 536500000 1 543500000 1 550500000 1 557500000 1 564500000 1 571500000 1 " +
					"578500000 1 585500000 1 592500000 1 599500000 1 606500000 1 613500000 1 620500000 1 627500000 1 " +
					"634500000 1 641500000 1 648500000 1 655500000 1 662500000 1 669500000 1 676500000 1 683500000 1 " +
					"690500000 1 697500000 1 704500000 1 711500000 1 718500000 1 725500000 1 732500000 1 739500000 1 " +
					"746500000 1 753500000 1 760500000 1 767500000 1 774500000 1 781500000 1 788500000 1 795500000 1 " +
					"802500000 1 809500000 1 816500000 1 810000000 0 818000000 0 826000000 0 834000000 0 842000000 0 " +
					"850000000 0 858000000 0 "),
		new TVRegion("Default DVB-T ITALY", TVChannelParams.MODE_OFDM,
					"177500000 1 184500000 1 186500000 1 191500000 1 194500000 1 198500000 1 203500000 1 205500000 1 212500000 1 219500000 1 226500000 1 " +
					"474000000 0 482000000 0 490000000 0 498000000 0 506000000 0 514000000 0 522000000 0 530000000 0 " +
					"538000000 0 546000000 0 554000000 0 562000000 0 570000000 0 578000000 0 586000000 0 594000000 0 " +
					"602000000 0 610000000 0 618000000 0 626000000 0 634000000 0 642000000 0 650000000 0 658000000 0 " +
					"666000000 0 674000000 0 682000000 0 690000000 0 698000000 0 706000000 0 714000000 0 722000000 0 " +
					"730000000 0 738000000 0 746000000 0 754000000 0 762000000 0 770000000 0 778000000 0 786000000 0 " +
					"794000000 0 802000000 0 810000000 0 818000000 0 826000000 0 834000000 0 842000000 0 850000000 0 " +					
					"858000000 0 "), 
		new TVRegion("Default DVB-T FRANCE", TVChannelParams.MODE_OFDM,
					"177500000 1 184500000 1 191500000 1 198500000 1 205500000 1 212500000 1 219500000 1 226500000 1 " +
					"474000000 0 482000000 0 490000000 0 498000000 0 506000000 0 514000000 0 522000000 0 530000000 0 " +
					"538000000 0 546000000 0 554000000 0 562000000 0 570000000 0 578000000 0 586000000 0 594000000 0 " +
					"602000000 0 610000000 0 618000000 0 626000000 0 634000000 0 642000000 0 650000000 0 658000000 0 " +
					"666000000 0 674000000 0 682000000 0 690000000 0 698000000 0 706000000 0 714000000 0 722000000 0 " +
					"730000000 0 738000000 0 746000000 0 754000000 0 762000000 0 770000000 0 778000000 0 786000000 0 " +
					"794000000 0 802000000 0 810000000 0 818000000 0 826000000 0 834000000 0 842000000 0 850000000 0 " +
					"858000000 0 "),  					
		new TVRegion("Default DVB-T TAIWAN", TVChannelParams.MODE_OFDM,
					"473000000 2 479000000 2 485000000 2 491000000 2 497000000 2 503000000 2 509000000 2 515000000 2 " +
					"521000000 2 527000000 2 533000000 2 539000000 2 545000000 2 551000000 2 557000000 2 563000000 2 " +
					"569000000 2 575000000 2 581000000 2 587000000 2 593000000 2 599000000 2 605000000 2 611000000 2 " +
					"617000000 2 623000000 2 629000000 2 635000000 2 641000000 2 647000000 2 653000000 2 659000000 2 " +
					"665000000 2 671000000 2 677000000 2 683000000 2 689000000 2 695000000 2 701000000 2 707000000 2 " +
					"713000000 2 719000000 2 725000000 2 731000000 2 737000000 2 743000000 2 749000000 2 755000000 2 " +
					"761000000 2 767000000 2 773000000 2 779000000 2 785000000 2 791000000 2 797000000 2 803000000 2 " +
					"809000000 2 815000000 2 821000000 2 827000000 2 833000000 2 839000000 2 845000000 2 851000000 2 " +
					"857000000 2 "),        
	};

	private void insertNewDimension(int region, String regionName, String name, 
	                        int indexj, int[] lock, String[] abbrev, String[] text){
		String cmd = "insert into dimension_table(rating_region,rating_region_name,name,graduated_scale,";
		cmd += "values_defined,index_j,version,abbrev0,text0,locked0,abbrev1,text1,locked1,abbrev2,text2,locked2,";
		cmd += "abbrev3,text3,locked3,abbrev4,text4,locked4,abbrev5,text5,locked5,abbrev6,text6,locked6,";
		cmd += "abbrev7,text7,locked7,abbrev8,text8,locked8,abbrev9,text9,locked9,abbrev10,text10,locked10,";
		cmd += "abbrev11,text11,locked11,abbrev12,text12,locked12,abbrev13,text13,locked13,abbrev14,text14,locked14,";
		cmd += "abbrev15,text15,locked15) values("+region+",'"+regionName+"','"+name+"',0,"+lock.length+","+indexj+",0";
		for (int i=0; i<16; i++){
			if (i < lock.length){
				cmd += ",'" + abbrev[i]+"'";
				cmd += ",'" + text[i]  +"'";
				cmd += ",'" + lock[i]  +"'";
			}else{
				cmd += ",''";
				cmd += ",''";
				cmd += ",-1";
			}
		}
		cmd += ")";
		
		getWritableDatabase().execSQL(cmd);
	}
	
	/**
	 * 生成Standard ATSC V-Chip Dimensions
	 */
	public void builtinAtscDimensions(){
		getWritableDatabase().execSQL("delete from dimension_table");
		
		/* Add U.S. Rating region 0x1 */
		String[] abbrev0 = {"","None","TV-G","TV-PG","TV-14","TV-MA"};
		String[] text0   = {"","None","TV-G","TV-PG","TV-14","TV-MA"};
		int[]    lock0   = {-1, -1,    0,      0,      0,     0};
		String[] abbrev1 = {"","D","TV-G","TV-PG","TV-14","TV-MA"};
		String[] text1   = {"","D","TV-G","TV-PG","TV-14","TV-MA"};
		int[]    lock1   = {-1, -1,    -1,      0,      0,     -1};
		String[] abbrev2 = {"","L","TV-G","TV-PG","TV-14","TV-MA"};
		String[] text2   = {"","L","TV-G","TV-PG","TV-14","TV-MA"};
		int[]    lock2   = {-1, -1,    -1,      0,      0,      0};
		String[] abbrev3 = {"","S","TV-G","TV-PG","TV-14","TV-MA"};
		String[] text3   = {"","S","TV-G","TV-PG","TV-14","TV-MA"};
		int[]    lock3   = {-1, -1,    -1,      0,      0,      0};
		String[] abbrev4 = {"","V","TV-G","TV-PG","TV-14","TV-MA"};
		String[] text4   = {"","V","TV-G","TV-PG","TV-14","TV-MA"};
		int[]    lock4   = {-1, -1,    -1,      0,      0,      0};
		String[] abbrev5 = {"","TV-Y","TV-Y7"};
		String[] text5   = {"","TV-Y","TV-Y7"};
		int[]    lock5   = {-1,  0,       0};
		String[] abbrev6 = {"","FV","TV-Y7"};
		String[] text6   = {"","FV","TV-Y7"};
		int[]    lock6   = {-1, -1,       0};
		String[] abbrev7 = {"","N/A","G","PG","PG-13","R","NC-17","X","NR"};
		String[] text7   = {"","MPAA Rating Not Applicable","Suitable for AllAges",
		                    "Parental GuidanceSuggested", "Parents Strongly Cautioned",
		                    "Restricted, under 17 must be accompanied by adult",
		                    "No One 17 and Under Admitted","No One 17 and Under Admitted",
		                    "“Not Rated by MPAA"};
		int[]    lock7   = {-1, -1, 0, 0, 0, 0, 0, 0, 0};
		/*Extra for 'All' */
		String[] abbrevall = {"TV-Y","TV-Y7","TV-G","TV-PG","TV-14","TV-MA"};
		String[] textall   = {"TV-Y","TV-Y7","TV-G","TV-PG","TV-14","TV-MA"};
		int[]    lockall   = {0,     0,      0,      0,      0,     0};
		
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"Entire Audience",  0, lock0, abbrev0, text0);
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"Dialogue",         1, lock1, abbrev1, text1);
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"Language",         2, lock2, abbrev2, text2);
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"Sex",              3, lock3, abbrev3, text3);
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"Violence",         4, lock4, abbrev4, text4);
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"Children",         5, lock5, abbrev5, text5);
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"Fantasy violence", 6, lock6, abbrev6, text6);
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"MPAA",             7, lock7, abbrev7, text7);
		insertNewDimension(TVDimension.REGION_US, "US (50 states + possessions)", 
			"All",             -1, lockall, abbrevall, textall);
		
		/* Add Canadian Rating region 0x2 */
		String[] cabbrev0 = {"E",     "C",       "C8+","G",      "PG","14+","18+"};
		String[] ctext0   = {"Exempt","Children","8+", "General","PG","14+","18+"};
		int[]    clock0   = {0,       0,         0,    0,        0,   0,    0};
		String[] cabbrev1 = {"E",        "G",        "8 ans+","13 ans+","16 ans+","18 ans+"};
		String[] ctext1   = {"Exemptées","Pour tous","8+",    "13+",    "16+",    "18+"};
		int[]    clock1   = {0,          0,          0,       0,        0,        0};
		
		insertNewDimension(TVDimension.REGION_CANADA, "Canada", 
			"Canadian English Language Rating", 0, clock0, cabbrev0, ctext0);
		insertNewDimension(TVDimension.REGION_CANADA, "Canada", 
			"Codes français du Canada",         1, clock1, cabbrev1, ctext1);
	}

	
    /*Load native library*/
    static {
        System.loadLibrary("jnitvdatabase");
    }

	public void unsetup(Context context){
		native_db_unsetup();
	}

	public TVDatabase(Context context, String dbName){
		super(context, dbName, null, DB_VERSION);

		SharedPreferences pref = PreferenceManager.getDefaultSharedPreferences(context);
		int curVer = pref.getInt(DB_VERSION_FIELD, -1);
		boolean create = false;

		File file = context.getDatabasePath(dbName);

		Log.d(TAG, "database version: DB_VERSION "+DB_VERSION+", curVer "+curVer);
		if(curVer != DB_VERSION || !file.exists()){
			create = true;
			if (file.exists()){
				Log.d(TAG, "Database version changed, delete the current database.");
				file.delete();
			}
		}

		native_db_setup(file.toString(), create, getWritableDatabase());

		if(create){
			ContentValues cv = new ContentValues();
			for (int i=0; i<tvRegions.length; i++) {
				Log.d(TAG, "Loading region "+tvRegions[i].name+", source "+tvRegions[i].source);
				cv.put("name", tvRegions[i].name);
				cv.put("source", tvRegions[i].source);
				cv.put("frequencies", tvRegions[i].freqList);
				getWritableDatabase().insert("region_table", "", cv);
				Log.d(TAG, tvRegions[i].name + " done !");
				cv.clear();
			}
			
			/* builtin default ATSC V-Chip dimensions */
			Log.d(TAG, "Generating builtin v-chip dimensions...");
			builtinAtscDimensions();

			pref.edit().putInt(DB_VERSION_FIELD, DB_VERSION).commit();
		}
	}

	public static void sync(){
		native_db_sync();
	}

	@Override
	public void onCreate(SQLiteDatabase db){
	}
	
	@Override
	public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion){
	}
}

